<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenAI API Example</title>
</head>
<body>
    <h1>OpenAI API Example</h1>
    
    <!-- API Key 입력 -->
    <label for="api-key">API Key:</label>
    <input type="text" id="api-key" name="api-key">
    <button id="set-api-key-button">Set API Key</button>
    <hr>
    
    <!-- Thread 등록 -->
    <label for="thread-id">Thread ID:</label>
    <input type="text" id="thread-id" name="thread-id">
    <button id="set-thread-button">Set Thread</button>
    <hr>
    
    <!-- Assistant 등록 -->
    <label for="assistant-id">Assistant ID:</label>
    <input type="text" id="assistant-id" name="assistant-id">
    <button id="set-assistant-button">Set Assistant</button>
    <button id="show-assistant-list">Show Assistant List</button>
    <hr>

    <!-- Assistant 생성 혹은 수정 -->
    <label for="assistant-id2">Create Or Update Assistant:</label><br>
    <label for="assistant-id2">Assistant ID:</label>
    <input type="text" id="assistant-id2" name="assistant-id2"><br>
    <label for="model">Model:</label>
    <select id="model" name="model">
        <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
        <option value="gpt-4">gpt-4</option>
        <option value="gpt-4-1106-preview">gpt-4-1106-preview</option>
        <!-- 추가 모델 옵션들을 여기에 추가할 수 있습니다 -->
    </select><br>
    <label for="instructions">Instructions:</label><br>
    <textarea id="instructions" name="instructions" rows="4" cols="50"></textarea><br>
    <button id="update-assistant-button">Update Assistant</button>
    <hr>
    
    <!-- 메시지 전송 -->
    <label for="user-message">Ask to GPT:</label><br>
    <textarea id="user-message" name="user-message" rows="4" cols="50"></textarea><br>
    <button id="send-message-button">Send Message</button>
    <hr>
        
    <!-- 쓰레드 내용 및 응답 요청 제어 -->
    <label for="response">fetch response:</label><br>
    <button id="show-message-list-button">Show Message List</button>
    <button id="run-assistant-button">Run, Get Response</button>
    <hr>

    <!-- 메시지 표시 -->
    <pre id="response"></pre>

    <script>
        let apiKey = '';

        async function getToken(apiKey) {
            const response = await fetch('https://api.openai.com/oauth/token', {
                method: 'POST',
                headers: {
                    'Authorization': `Basic ${btoa(apiKey + ':')}`,
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({
                    'grant_type': 'client_credentials'
                })
            });

            if (!response.ok) {
                const errorDetails = await response.json();
                throw new Error(`Error fetching token! status: ${response.status}, details: ${JSON.stringify(errorDetails)}`);
            }

            const data = await response.json();
            return data.access_token;
        }

        document.getElementById('set-api-key-button').addEventListener('click', () => {
            apiKey = document.getElementById('api-key').value.trim();
            getToken(apiKey).then(token => {
                alert('Token:', token);
            }).catch(error => {
                console.error('Error:', error);
            });
            alert('API Key set!');
        });

        
        document.getElementById('set-thread-button').addEventListener('click', async () => {
            const threadId = document.getElementById('thread-id').value.trim();
            const responseElement = document.getElementById('response');
            
            try {
                let response = await fetch(`https://api.openai.com/v1/threads/${threadId}/messages`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json',
                        'OpenAI-Beta': 'assistants=v2'
                    }
                });

                if (response.status === 404) {
                    response = await fetch('https://api.openai.com/v1/threads', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json',
                            'OpenAI-Beta': 'assistants=v2'
                        }
                    });

                    const data = await response.json();
                    document.getElementById('thread-id').value = data.id;
                    responseElement.textContent = 'New thread created. ID: ' + data.id;
                } else {
                    const data = await response.json();
                    responseElement.textContent = JSON.stringify(data, null, 4);
                }
            } catch (error) {
                responseElement.textContent = `Error: ${error.message}`;
            }
        });

        document.getElementById('show-assistant-list').addEventListener('click', async () => {
            const responseElement = document.getElementById('response');

            try {
                const response = await fetch(`https://api.openai.com/v1/assistants`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json',
                        'OpenAI-Beta': 'assistants=v2'
                    }
                });

                if (!response.ok) {
                    const errorDetails = await response.json();
                    throw new Error(`Error fetching assistants! status: ${response.status}, details: ${JSON.stringify(errorDetails)}`);
                }

                const data = await response.json();
                responseElement.textContent = JSON.stringify(data, null, 4);
            } catch (error) {
                responseElement.textContent = `Error: ${error.message}`;
            }
        });

        document.getElementById('set-assistant-button').addEventListener('click', async () => {
            const assistantId = document.getElementById('assistant-id').value.trim();
            const responseElement = document.getElementById('response');

            try {
                const response = await fetch(`https://api.openai.com/v1/assistants/${assistantId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json',
                        'OpenAI-Beta': 'assistants=v2'
                    }
                });

                if (!response.ok) {
                    if (response.status === 404) {
                        responseElement.textContent = 'Assistant does not exist.';
                    } else {
                        const errorDetails = await response.json();
                        throw new Error(`Error checking assistant! status: ${response.status}, details: ${JSON.stringify(errorDetails)}`);
                    }
                } else {
                    const data = await response.json();
                    responseElement.textContent = JSON.stringify(data, null, 4);
                }
            } catch (error) {
                responseElement.textContent = `Error: ${error.message}`;
            }
        });

        document.getElementById('update-assistant-button').addEventListener('click', async () => {
            const assistantId = document.getElementById('assistant-id2').value.trim();
            const instructions = document.getElementById('instructions').value.trim();
            const model = document.getElementById('model').value.trim();
            const responseElement = document.getElementById('response');

            try {
                let response = await fetch(`https://api.openai.com/v1/assistants`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json',
                        'OpenAI-Beta': 'assistants=v2'
                    },
                    body: JSON.stringify({
                        name: assistantId,
                        instructions: instructions,
                        model: model
                    })
                });

                if (!response.ok) {
                    const errorDetails = await response.json();
                    throw new Error(`Error updating assistant! status: ${response.status}, details: ${JSON.stringify(errorDetails)}`);
                }

                const data = await response.json();
                document.getElementById('assistant-id2').value = data.id;
                responseElement.textContent = JSON.stringify(data, null, 4);
            } catch (error) {
                responseElement.textContent = `Error: ${error.message}`;
            }
        });

        document.getElementById('run-assistant-button').addEventListener('click', async () => {
            const threadId = document.getElementById('thread-id').value.trim();
            const assistantId = document.getElementById('assistant-id').value.trim();
            const instructions = document.getElementById('instructions').value.trim();
            const responseElement = document.getElementById('response');

            try {
                // 어시스턴트를 실행하는 fetch 요청
                const response = await fetch(`https://api.openai.com/v1/threads/${threadId}/runs`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json',
                        'OpenAI-Beta': 'assistants=v2'
                    },
                    body: JSON.stringify({
                        assistant_id: assistantId,
                        instructions: instructions
                    })
                });

                if (!response.ok) {
                    const errorDetails = await response.json();
                    throw new Error(`Error running assistant! status: ${response.status}, details: ${JSON.stringify(errorDetails)}`);
                }
              

                const data = await response.json();
                responseElement.textContent = JSON.stringify(data, null, 4);

                const runId = data.id;

                // 주기적으로 상태를 확인하는 함수
                const checkRunStatus = async () => {
                    try {
                        const statusResponse = await fetch(`https://api.openai.com/v1/threads/${threadId}/runs/${runId}`, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${apiKey}`,
                                'Content-Type': 'application/json',
                                'OpenAI-Beta': 'assistants=v2'
                            }
                        });

                        if (!statusResponse.ok) {
                            const errorDetails = await statusResponse.json();
                            throw new Error(`Error checking run status! status: ${statusResponse.status}, details: ${JSON.stringify(errorDetails)}`);
                        }

                        const statusData = await statusResponse.json();

                        if (statusData.status === 'completed') {
                            clearInterval(intervalId); // 상태 체크 중지

                            // 메시지 목록 갱신을 위한 fetch 요청
                            const messageResponse = await fetch(`https://api.openai.com/v1/threads/${threadId}/messages`, {
                                method: 'GET',
                                headers: {
                                    'Authorization': `Bearer ${apiKey}`,
                                    'Content-Type': 'application/json',
                                    'OpenAI-Beta': 'assistants=v2'
                                }
                            });

                            if (!messageResponse.ok) {
                                const errorDetails = await messageResponse.json();
                                throw new Error(`Error fetching messages! status: ${messageResponse.status}, details: ${JSON.stringify(errorDetails)}`);
                            }

                            const messageData = await messageResponse.json();
                            responseElement.textContent = JSON.stringify(messageData, null, 4);
                        }
                    } catch (error) {
                        clearInterval(intervalId); // 상태 체크 중지
                        responseElement.textContent = `Error: ${error.message}`;
                    }
                };

                // 0.5초마다 상태를 확인
                const intervalId = setInterval(checkRunStatus, 1000);
            } catch (error) {
                responseElement.textContent = `Error: ${error.message}`;
            }
        });



        
        document.getElementById('show-message-list-button').addEventListener('click', async () => {
            const threadId = document.getElementById('thread-id').value.trim();
            const responseElement = document.getElementById('response');

            try {
                const response = await fetch(`https://api.openai.com/v1/threads/${threadId}/messages`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json',
                        'OpenAI-Beta': 'assistants=v2'
                    }
                });

                if (!response.ok) {
                    const errorDetails = await response.json();
                    throw new Error(`Error fetching messages! status: ${response.status}, details: ${JSON.stringify(errorDetails)}`);
                }

                const data = await response.json();
                responseElement.textContent = JSON.stringify(data, null, 4);
            } catch (error) {
                responseElement.textContent = `Error: ${error.message}`;
            }
        });

        document.getElementById('send-message-button').addEventListener('click', async () => {
            const threadId = document.getElementById('thread-id').value.trim();
            const userMessage = document.getElementById('user-message').value.trim();
            const responseElement = document.getElementById('response');

            try {
                const response = await fetch(`https://api.openai.com/v1/threads/${threadId}/messages`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json',
                        'OpenAI-Beta': 'assistants=v2'
                    },
                    body: JSON.stringify({
                        role: "user",
                        content: userMessage
                    })
                });

                if (!response.ok) {
                    const errorDetails = await response.json();
                    throw new Error(`Error sending message! status: ${response.status}, details: ${JSON.stringify(errorDetails)}`);
                }

                const data = await response.json();
                responseElement.textContent = JSON.stringify(data, null, 4);
            } catch (error) {
                responseElement.textContent = `Error: ${error.message}`;
            }
        });

    </script>
</body>
</html>
